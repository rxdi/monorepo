#!/usr/bin/env node
(function () {var j={},ca=j&&j.__awaiter||function(r,$,e,t){return new(e||(e=Promise))(function(i,H){function a(r){try{p(t.next(r))}catch($){H($)}}function n(r){try{p(t.throw(r))}catch($){H($)}}function p(r){var $;r.done?i(r.value):($=r.value,$ instanceof e?$:new e(function(r){r($)})).then(a,n)}p((t=t.apply(r,$||[])).next())})};Object.defineProperty(j,"__esModule",{value:!0});const bb=require("util"),ab=require("fs");function Xa(r){return ca(this,void 0,void 0,function*(){return bb.promisify(ab.mkdir)(r)})}var i=Xa;j.makeDir=i;var b={};Object.defineProperty(b,"__esModule",{value:!0});var Qa="src";b.MAIN_FOLDER=Qa;var Na={shared:"@shared",lib:"@lib",apps:"@apps"};b.CONFIG=Na;var s={},Ma=s&&s.__awaiter||function(t,e,$,r){return new($||($=Promise))(function(i,n){function c(t){try{a(r.next(t))}catch(e){n(e)}}function o(t){try{a(r.throw(t))}catch(e){n(e)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof $?e:new $(function(t){t(e)})).then(c,o)}a((r=r.apply(t,e||[])).next())})};Object.defineProperty(s,"__esModule",{value:!0});const Ja=require("util"),Ia=require("fs");function Da(t){return Ma(this,void 0,void 0,function*(){return Ja.promisify(Ia.exists)(t)})}var S=Da;s.checkExist=S;var c={},Z=c&&c.__awaiter||function(e,t,r,$){return new(r||(r=Promise))(function(n,i){function a(e){try{c($.next(e))}catch(t){i(t)}}function o(e){try{c($.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(a,o)}c(($=$.apply(e,t||[])).next())})};Object.defineProperty(c,"__esModule",{value:!0});const sa=require("util"),la=require("fs"),ja=require("path");function ia(e,t,r="tsconfig.json"){return Z(this,void 0,void 0,function*(){yield sa.promisify(la.writeFile)(ja.join(t,r),JSON.stringify(e,null,2),{encoding:"utf-8"})})}var fa=ia;c.createTsConfig=fa;var n={},ea=n&&n.__awaiter||function(e,t,r,i){return new(r||(r=Promise))(function(a,o){function s(e){try{n(i.next(e))}catch(t){o(t)}}function c(e){try{n(i.throw(e))}catch(t){o(t)}}function n(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,c)}n((i=i.apply(e,t||[])).next())})};Object.defineProperty(n,"__esModule",{value:!0});const y=require("path");function da(){return ea(this,void 0,void 0,function*(){try{yield i(b.MAIN_FOLDER)}catch(e){}yield c.createTsConfig({compilerOptions:{module:"commonjs",target:"es6",declaration:!0,moduleResolution:"node",emitDecoratorMetadata:!0,experimentalDecorators:!0,removeComments:!0,allowSyntheticDefaultImports:!0,preserveConstEnums:!0,sourceMap:!0,strictNullChecks:!1,forceConsistentCasingInFileNames:!0,noFallthroughCasesInSwitch:!0,noImplicitAny:!1,noImplicitReturns:!0,noImplicitThis:!1,noUnusedLocals:!0,noUnusedParameters:!1,outDir:"./node_modules",lib:["es2017","es2016","es2015","es6","dom","esnext.asynciterable"],typeRoots:["node_modules/@types"]},include:["./src/**/*"],exclude:["node_modules/**/*","./src/**/*.spec.ts"]},process.cwd()),yield c.createTsConfig({references:[{path:"./@lib/"},{path:"./@shared/"}]},y.join(process.cwd(),b.MAIN_FOLDER)),yield c.createTsConfig({compilerOptions:{target:"es2015",module:"commonjs",declaration:!0,declarationMap:!0,sourceMap:!0,strict:!0,composite:!0,esModuleInterop:!0}},y.join(process.cwd(),b.MAIN_FOLDER),"tsconfig.settings.json");for(const t of Object.values(b.CONFIG)){const r=y.join(process.cwd(),b.MAIN_FOLDER,t);if(!(yield S(r)))try{yield i(r),yield Ca(),yield c.createTsConfig({references:[]},r)}catch(e){}}})}var M=da;function Ca(){return new Promise(e=>setTimeout(()=>e(),100))}n.createWorkspace=M;var r={},ua=r&&r.__awaiter||function(e,r,t,a){return new(t||(t=Promise))(function($,n){function o(e){try{i(a.next(e))}catch(r){n(r)}}function c(e){try{i(a.throw(e))}catch(r){n(r)}}function i(e){var r;e.done?$(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,c)}i((a=a.apply(e,r||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0});function ga(){return ua(this,void 0,void 0,function*(){yield M()})}var R=ga;r.Create=R;var u={},_a=u&&u.__awaiter||function(t,e,r,$){return new(r||(r=Promise))(function(n,a){function i(t){try{c($.next(t))}catch(e){a(e)}}function o(t){try{c($.throw(t))}catch(e){a(e)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r(function(t){t(e)})).then(i,o)}c(($=$.apply(t,e||[])).next())})};Object.defineProperty(u,"__esModule",{value:!0});const v=require("path"),ta=require("util"),oa=require("fs");function $a(t,e){return _a(this,void 0,void 0,function*(){const r=v.join(process.cwd(),b.MAIN_FOLDER,b.CONFIG[e]),$=v.join(r,t);try{yield i($)}catch(i){}yield ta.promisify(oa.writeFile)(v.join($,"index.ts"),"export function MyLibFunction() {\n    return {}\n  }",{encoding:"utf-8"}),yield c.createTsConfig({extends:"../../tsconfig.settings.json",compilerOptions:{declaration:!0,outDir:`../../../node_modules/${b.CONFIG[e]}/${t}`}},$);const n=v.join(r,"tsconfig.json"),a=require(n);if(!a.references)throw new Error(`Missing "references" inside ${n}`);if(a.references.find(e=>e.path===`./${t}`))throw new Error(`Module already present with name ${t}`);a.references.push({path:`./${t}`}),yield c.createTsConfig(a,r)})}var F=$a;u.createModule=F;var t={},ka=t&&t.__awaiter||function(e,r,t,$){return new(t||(t=Promise))(function(a,n){function o(e){try{c($.next(e))}catch(r){n(r)}}function l(e){try{c($.throw(e))}catch(r){n(r)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,l)}c(($=$.apply(e,r||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});function na(e){return ka(this,void 0,void 0,function*(){yield F(e,"lib")})}var K=na;t.createLib=K;var f={},xa=f&&f.__awaiter||function(e,r,t,$){return new(t||(t=Promise))(function(a,i){function n(e){try{c($.next(e))}catch(r){i(r)}}function o(e){try{c($.throw(e))}catch(r){i(r)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(n,o)}c(($=$.apply(e,r||[])).next())})};Object.defineProperty(f,"__esModule",{value:!0});function za(e){return xa(this,void 0,void 0,function*(){yield K(e)})}var Aa=za;f.CreateLib=Aa;var p={},La=p&&p.__awaiter||function(e,r,o,t){return new(o||(o=Promise))(function(a,$){function n(e){try{c(t.next(e))}catch(r){$(r)}}function f(e){try{c(t.throw(e))}catch(r){$(r)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof o?r:new o(function(e){e(r)})).then(n,f)}c((t=t.apply(e,r||[])).next())})};Object.defineProperty(p,"__esModule",{value:!0});function Sa(e){return La(this,void 0,void 0,function*(){yield F(e,"shared")})}var L=Sa;p.CreateShared=L;var o={},$=o&&o.__awaiter||function(r,e,o,t){return new(o||(o=Promise))(function($,i){function u(r){try{p(t.next(r))}catch(e){i(e)}}function n(r){try{p(t.throw(r))}catch(e){i(e)}}function p(r){var e;r.done?$(r.value):(e=r.value,e instanceof o?e:new o(function(r){r(e)})).then(u,n)}p((t=t.apply(r,e||[])).next())})};Object.defineProperty(o,"__esModule",{value:!0});const _=require("util"),aa=require("child_process");function ba(r){return $(this,void 0,void 0,function*(){return(yield _.promisify(aa.execFile)("find",[r])).stdout.split("\n")})}var A=ba;o.readDir=A;var z={};Object.defineProperty(z,"__esModule",{value:!0});var q=e=>process.argv.toString().includes(e);z.includes=q;var H=(e,r=!0,t=e=>e)=>{if(process.argv.toString().includes(e)){const s=process.argv[process.argv.indexOf(e)+1];return s?s.includes("--")?r:t(s):r}return r};z.nextOrDefault=H;var N={};Object.defineProperty(N,"__esModule",{value:!0});const ha=require("child_process");var G=s=>new Promise(r=>{const e=["tsc"];q("--watch")&&e.push("--watch");const o=ha.spawn("npx",e,{cwd:s});function p(s){s.kill()}o.stdout.pipe(process.stdout),o.stderr.pipe(process.stderr),process.on("exit",p.bind(null,o)),process.on("SIGINT",()=>process.exit()),process.on("SIGUSR1",p.bind(null,o)),process.on("SIGUSR2",p.bind(null,o)),process.on("uncaughtException",p.bind(null,o)),o.on("close",s=>r(s))});N.TranspileTypescript=G;var m={},O=m&&m.__awaiter||function(r,e,$,a){return new($||($=Promise))(function(t,i){function s(r){try{o(a.next(r))}catch(e){i(e)}}function n(r){try{o(a.throw(r))}catch(e){i(e)}}function o(r){var e;r.done?t(r.value):(e=r.value,e instanceof $?e:new $(function(r){r(e)})).then(s,n)}o((a=a.apply(r,e||[])).next())})};Object.defineProperty(m,"__esModule",{value:!0});const g=require("path");function ma(){return O(this,void 0,void 0,function*(){const r=[...(yield A(g.join(process.cwd(),b.MAIN_FOLDER,b.CONFIG.shared))),...(yield A(g.join(process.cwd(),b.MAIN_FOLDER,b.CONFIG.lib)))].filter(r=>r.includes(".ts")).map(r=>r.replace(process.cwd(),""));return q("--multi-compile")?yield G(process.cwd()):yield Promise.all(r.map(r=>O(this,void 0,void 0,function*(){const e=g.normalize(g.join(process.cwd(),r)),$=e.substring(0,e.lastIndexOf("/"));yield G($)})))})}var P=ma;m.compileWorkspace=P;var Q={};Object.defineProperty(Q,"__esModule",{value:!0});const pa=require("child_process"),qa=require("path");function ra(e,r){return new Promise(s=>{const o=pa.spawn("cp",["-r",qa.join(process.cwd(),"node_modules",b.CONFIG[e]),r],{cwd:process.cwd()});o.stdout.pipe(process.stdout),o.stderr.pipe(process.stderr),o.on("close",e=>s(e))})}var C=ra;Q.copyModules=C;var k={},I=k&&k.__awaiter||function($,e,r,c){return new(r||(r=Promise))(function(a,o){function t($){try{i(c.next($))}catch(e){o(e)}}function s($){try{i(c.throw($))}catch(e){o(e)}}function i($){var e;$.done?a($.value):(e=$.value,e instanceof r?e:new r(function($){$(e)})).then(t,s)}i((c=c.apply($,e||[])).next())})};Object.defineProperty(k,"__esModule",{value:!0});const va=require("util"),wa=require("fs"),x=require("path");function ya(){return I(this,void 0,void 0,function*(){yield P();const $=yield va.promisify(wa.readdir)(x.join(process.cwd(),b.MAIN_FOLDER,b.CONFIG.apps));q("--copy-modules")&&(yield Promise.all($.map($=>I(this,void 0,void 0,function*(){yield C("lib",x.join(process.cwd(),b.MAIN_FOLDER,b.CONFIG.apps,$,"node_modules")),yield C("shared",x.join(process.cwd(),b.MAIN_FOLDER,b.CONFIG.apps,$,"node_modules"))}))))})}var T=ya;k.Compile=T;var U={};Object.defineProperty(U,"__esModule",{value:!0});const Ba=require("child_process");var V=(s,e=process.cwd(),o)=>new Promise(r=>{console.log(`Starting process: "${s}" Directory: ${e}`);const n=Ba.spawn("npx",s.split(" "),{cwd:e});function c(s){s.kill()}n.stdout.on("data",s=>{s.toString().includes(o)&&(console.log(`Resolve signal triggered '${o}'`),r(s))}),n.stdout.pipe(process.stdout),n.stderr.pipe(process.stderr),process.stdin.resume(),process.on("exit",c.bind(null,n)),process.on("SIGINT",()=>process.exit()),process.on("SIGUSR1",c.bind(null,n)),process.on("SIGUSR2",c.bind(null,n)),process.on("uncaughtException",c.bind(null,n)),n.on("close",s=>r(s))});U.RunProcess=V;var d={},Ea=d&&d.__awaiter||function(r,e,t,$){return new(t||(t=Promise))(function(a,o){function n(r){try{s($.next(r))}catch(e){o(e)}}function i(r){try{s($.throw(r))}catch(e){o(e)}}function s(r){var e;r.done?a(r.value):(e=r.value,e instanceof t?e:new t(function(r){r(e)})).then(n,i)}s(($=$.apply(r,e||[])).next())})};Object.defineProperty(d,"__esModule",{value:!0});const Fa=require("path");function Ga(){return Ea(this,void 0,void 0,function*(){return console.log(H("-c","repo.json")),require(Fa.join(process.cwd(),H("-c","repo.json")))})}var Ha=Ga;d.readConfig=Ha;var h={},D=h&&h.__awaiter||function(n,e,o,r){return new(o||(o=Promise))(function(t,i){function s(n){try{$(r.next(n))}catch(e){i(e)}}function a(n){try{$(r.throw(n))}catch(e){i(e)}}function $(n){var e;n.done?t(n.value):(e=n.value,e instanceof o?e:new o(function(n){n(e)})).then(s,a)}$((r=r.apply(n,e||[])).next())})};Object.defineProperty(h,"__esModule",{value:!0});function Ka(n){return D(this,void 0,void 0,function*(){const e=yield d.readConfig();const o=Object.keys(e.stacks).map(n=>({name:n,options:e.stacks[n].options,commands:Object.keys(e.stacks[n].commands).map(o=>e.stacks[n].commands[o])}));let r=[...o];n&&!n.includes("-c")&&(r=r.filter(e=>e.name===n));let t=r.filter(n=>n.options&&n.options.depends);const i=[];t.forEach(n=>{for(const e of n.options.depends){const r=o.find(n=>n.name===e);if(!r)throw new Error(`Missing depend ${e} inside service ${JSON.stringify(n,null,2)}`);t.find(n=>n.name===r.name)||i.push(r)}});const s=[...new Set(i.map(n=>n.name).map(n=>o.find(e=>e.name===n)))];for(const n of s)yield B(n);yield Promise.all(t.map(n=>D(this,void 0,void 0,function*(){return yield B(n)}))),r=r.filter(n=>!t.includes({name:n.name})&&!t.filter(e=>e.options.depends.find(e=>e===n.name)).length&&!t.find(e=>e.name===n.name)),yield Promise.all(r.map(n=>B(n)))})}var W=Ka;function B(n){return D(this,void 0,void 0,function*(){if(!n)throw new Error(`Missing stack ${JSON.stringify(n)}`);for(const e of n.commands)n.options=n.options||{},yield V(e,n.options.cwd,n.options.signal)})}h.Run=W;var w={};Object.defineProperty(w,"__esModule",{value:!0});const Oa=require("child_process");var Pa=s=>new Promise(e=>{const r=Oa.spawn("npx",["npm","install"],{cwd:s});r.stdout.pipe(process.stdout),r.stderr.pipe(process.stderr),r.on("close",s=>e(s))});w.NpmInstall=Pa;var a={},Ra=a&&a.__awaiter||function(n,$,t,a){return new(t||(t=Promise))(function(r,e){function i(n){try{o(a.next(n))}catch($){e($)}}function s(n){try{o(a.throw(n))}catch($){e($)}}function o(n){var $;n.done?r(n.value):($=n.value,$ instanceof t?$:new t(function(n){n($)})).then(i,s)}o((a=a.apply(n,$||[])).next())})};Object.defineProperty(a,"__esModule",{value:!0});const X=require("path"),Ta=require("util"),Ua=require("fs");function Va(){return Ra(this,void 0,void 0,function*(){const n=X.join(process.cwd(),b.MAIN_FOLDER,b.CONFIG.apps),$=yield Ta.promisify(Ua.readdir)(n);console.log(`Executing 'npm install' on following @apps: '${$}'`),yield Promise.all($.map($=>w.NpmInstall(X.join(n,$))))})}var Wa=Va;a.installApps=Wa;var l={},Ya=l&&l.__awaiter||function(n,r,t,$){return new(t||(t=Promise))(function(a,e){function l(n){try{s($.next(n))}catch(r){e(r)}}function o(n){try{s($.throw(n))}catch(r){e(r)}}function s(n){var r;n.done?a(n.value):(r=n.value,r instanceof t?r:new t(function(n){n(r)})).then(l,o)}s(($=$.apply(n,r||[])).next())})};Object.defineProperty(l,"__esModule",{value:!0});function Za(){return Ya(this,void 0,void 0,function*(){yield a.installApps()})}var Y=Za;l.Install=Y;var J={};Object.defineProperty(J,"__esModule",{value:!0});var E=new Map([["create",R],["lib",f.CreateLib],["shared",L],["compile",T],["run",W],["install",Y]]);J.Tasks=E;var e={},cb=e&&e.__awaiter||function(t,r,e,a){return new(e||(e=Promise))(function(c,n){function $(t){try{o(a.next(t))}catch(r){n(r)}}function s(t){try{o(a.throw(t))}catch(r){n(r)}}function o(t){var r;t.done?c(t.value):(r=t.value,r instanceof e?r:new e(function(t){t(r)})).then($,s)}o((a=a.apply(t,r||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});function db(){return cb(this,void 0,void 0,function*(){let t=process.argv.slice(2);if(!E.has(t[0]))throw new Error(`Missing task ${t[0]}`);try{yield E.get(t[0])(t[1])}catch(r){console.error(r)}})}db();if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e}else if(typeof define==="function"&&define.amd){define(function(){return e})}})();